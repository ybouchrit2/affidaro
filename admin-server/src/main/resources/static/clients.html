<!doctype html>
<html lang="ar" dir="rtl" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>العملاء - Affidaro Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/custom.css">
  <!-- Custom styles for sidebar, header, cards, and responsive tables -->
</head>
<body>
<div class="d-flex">
  <aside class="sidebar bg-dark text-white p-3">
    <h3 class="mb-4 text-center">Affidaro Admin</h3>
    <ul class="nav flex-column">
      <li class="nav-item mb-2"><a href="/dashboard.html" class="nav-link text-white"><i class="bi bi-speedometer2 me-2"></i> لوحة التحكم</a></li>
      <li class="nav-item mb-2"><a href="/clients.html" class="nav-link text-primary"><i class="bi bi-people me-2"></i> العملاء</a></li>
      <li class="nav-item mb-2"><a href="/leads.html" class="nav-link text-white"><i class="bi bi-lightbulb me-2"></i> الطلبات</a></li>
      <li class="nav-item mb-2"><a href="/contracts.html" class="nav-link text-white"><i class="bi bi-file-earmark-text me-2"></i> العقود</a></li>
      <li class="nav-item mb-2"><a href="/analytics.html" class="nav-link text-white"><i class="bi bi-graph-up me-2"></i> التحليلات</a></li>
      <li class="nav-item mb-2"><a href="/communications.html" class="nav-link text-white"><i class="bi bi-chat-dots me-2"></i> الاتصالات</a></li>
    </ul>
  </aside>

  <main class="flex-grow-1">
    <nav class="navbar navbar-expand bg-white shadow-sm p-3 sticky-top">
      <div class="container-fluid">
        <div class="input-group w-50">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="searchInput" class="form-control" type="search" placeholder="ابحث باسم/بريد/هاتف" aria-label="Search">
        </div>
        <div class="ms-3 d-flex gap-2">
          <select id="statusFilter" class="form-select form-select-sm" style="max-width:180px">
            <option value="">كل الحالات</option>
            <option value="lead">Lead</option>
            <option value="interested">Interested</option>
            <option value="active">Active</option>
            <option value="rejected">Rejected</option>
          </select>
          <select id="classificationFilter" class="form-select form-select-sm" style="max-width:180px">
            <option value="">كل التصنيفات</option>
            <option value="vip">VIP</option>
            <option value="regular">Regular</option>
            <option value="prospect">Prospect</option>
          </select>
          <select id="pipelineFilter" class="form-select form-select-sm" style="max-width:220px">
            <option value="">كل مراحل الأنابيب</option>
            <option value="new">New</option>
            <option value="contacted">Contacted</option>
            <option value="qualified">Qualified</option>
            <option value="proposal">Proposal</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
          <input id="dateStart" type="date" class="form-control form-control-sm" />
          <input id="dateEnd" type="date" class="form-control form-control-sm" />
        </div>
        <div class="d-flex gap-2">
          <button id="refreshBtn" class="btn btn-outline-primary"><i class="bi bi-arrow-repeat"></i> تحديث</button>
          <button id="exportClients" class="btn btn-outline-success"><i class="bi bi-filetype-csv"></i> تصدير CSV</button>
          <button id="addClient" class="btn btn-primary"><i class="bi bi-plus-lg"></i> إضافة عميل</button>
        </div>
      </div>
    </nav>

    <div id="apiAlert" class="alert alert-warning mx-4 mt-3 d-none" role="alert">
      تعذّر الاتصال بواجهة البرمجة الخلفية. يتم عرض البيانات المتاحة فقط.
    </div>

    <section class="p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">قائمة العملاء</h4>
        <div>
          <button id="prevPage" class="btn btn-outline-secondary btn-sm"><i class="bi bi-chevron-right"></i> السابق</button>
          <button id="nextPage" class="btn btn-outline-secondary btn-sm">التالي <i class="bi bi-chevron-left"></i></button>
          <span class="ms-2" id="pageInfo" class="text-muted"></span>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle" id="clientsTable">
          <thead class="table-light">
            <tr>
              <th data-key="name" class="sortable">الاسم <i class="bi bi-arrow-down-up"></i></th>
              <th data-key="status" class="sortable">الحالة <i class="bi bi-arrow-down-up"></i></th>
              <th>عدد العقود</th>
              <th>آخر زيارة</th>
              <th>التصنيف</th>
              <th>مرحلة المسار</th>
              <th data-key="createdAt" class="sortable">أُنشئ <i class="bi bi-arrow-down-up"></i></th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
const apiBase = '/api/clients';
let page = 0, size = 20;
let currentData = [];
let sortKey = 'createdAt';
let sortDir = 'desc';
const clientStats = new Map(); // id -> {agreementsCount, lastVisitTs}

async function fetchClients() {
  try {
    const q = document.getElementById('searchInput').value.trim();
    let url = q ? `${apiBase}/search?q=${encodeURIComponent(q)}` : `${apiBase}?page=${page}&size=${size}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    currentData = Array.isArray(data) ? data : (data.content || []);
    document.getElementById('apiAlert').classList.add('d-none');
  } catch(e) {
    currentData = [];
    document.getElementById('apiAlert').classList.remove('d-none');
  }
  renderTable();
  document.getElementById('pageInfo').textContent = `صفحة ${page+1}`;
}

function renderTable(){
  const tbody = document.querySelector('#clientsTable tbody');
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const st = document.getElementById('statusFilter').value;
  const cf = document.getElementById('classificationFilter')?.value || '';
  const pf = document.getElementById('pipelineFilter')?.value || '';
  const ds = document.getElementById('dateStart').value;
  const de = document.getElementById('dateEnd').value;
  const filtered = currentData.filter(c => {
    const matchesQ = !q || [c.name,c.email,c.phone].some(v => (v||'').toLowerCase().includes(q));
    const matchesSt = !st || (c.status||'').toLowerCase() === st;
    const matchesCf = !cf || (c.classification||'').toLowerCase() === cf;
    const matchesPf = !pf || (c.pipelineStage||'').toLowerCase() === pf;
    let matchesDate = true;
    if (ds) { const sMs = new Date(ds).getTime(); const ca = new Date(c.createdAt).getTime(); matchesDate = matchesDate && (ca >= sMs); }
    if (de) { const eMs = new Date(de).getTime()+86400000-1; const ca = new Date(c.createdAt).getTime(); matchesDate = matchesDate && (ca <= eMs); }
    return matchesQ && matchesSt && matchesCf && matchesPf && matchesDate;
  });
  const sorted = [...filtered].sort((a,b)=>{
    let va = a[sortKey], vb = b[sortKey];
    va = va ?? ''; vb = vb ?? '';
    if (sortKey === 'createdAt') { va = new Date(va).getTime() || 0; vb = new Date(vb).getTime() || 0; }
    if (typeof va === 'string') va = va.toLowerCase();
    if (typeof vb === 'string') vb = vb.toLowerCase();
    return sortDir === 'asc' ? (va > vb ? 1 : va < vb ? -1 : 0) : (va < vb ? 1 : va > vb ? -1 : 0);
  });
  tbody.innerHTML = sorted.map(c => {
    const stats = clientStats.get(c.id) || {};
    const lastVisit = stats.lastVisitTs ? formatDate(stats.lastVisitTs) : '';
    const agreementsCount = stats.agreementsCount ?? '';
    return `
    <tr>
      <td>${safe(c.name)}</td>
      
      <td>${statusBadge(c.status)}</td>
      <td>${agreementsCount}</td>
      <td>${lastVisit}</td>
      <td>${classBadge(c.classification)}</td>
      <td><span class="badge bg-info">${safe(c.pipelineStage)}</span></td>
      <td>${formatDate(c.createdAt)}</td>
      <td>
        <div class="btn-group btn-group-sm" role="group">
          <a class="btn btn-outline-primary" href="contracts.html?client=${encodeURIComponent(c.name||'')}">العقود</a>
          <a class="btn btn-outline-secondary" href="visits.html?client=${encodeURIComponent(c.name||'')}">الزيارات</a>
          <button class="btn btn-outline-info" onclick="viewClient('${c.id}')">تفاصيل</button>
          <button class="btn btn-outline-warning" onclick="editClient('${c.id}')">تعديل</button>
          <button class="btn btn-outline-danger" onclick="deleteClient('${c.id}')">حذف</button>
        </div>
      </td>
    </tr>
  `;
  }).join('');
}

function statusBadge(s){
  const m = {
    'lead': ['bg-warning','bi-lightbulb'],
    'meeting': ['bg-info','bi-calendar-event'],
    'agreed': ['bg-primary','bi-hand-thumbs-up'],
    'closed': ['bg-success','bi-check-circle'],
    'rejected': ['bg-danger','bi-x-circle']
  };
  const [cls, icon] = m[s] || ['bg-secondary','bi-dot'];
  return `<span class="badge ${cls}"><i class="bi ${icon}"></i> ${safe(s)}</span>`;
}
function classBadge(s){
  const m = {
    'vip': ['bg-purple','bi-star'],
    'active': ['bg-success','bi-person-check'],
    'former': ['bg-secondary','bi-person'],
    'lead': ['bg-warning','bi-person-plus']
  };
  const [cls, icon] = m[s] || ['bg-light','bi-person'];
  return `<span class="badge ${cls}"><i class="bi ${icon}"></i> ${safe(s)}</span>`;
}
function safe(s){ return (s ?? '').toString(); }
function formatDate(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleString('ar-EG'); }

document.getElementById('prevPage').addEventListener('click', ()=>{ if(page>0){ page--; fetchClients(); } });
document.getElementById('nextPage').addEventListener('click', ()=>{ page++; fetchClients(); });
document.getElementById('refreshBtn').addEventListener('click', fetchClients);
document.getElementById('searchInput').addEventListener('input', ()=>{ page = 0; fetchClients(); });
document.getElementById('statusFilter').addEventListener('change', renderTable);
document.getElementById('classificationFilter').addEventListener('change', renderTable);
document.getElementById('pipelineFilter').addEventListener('change', renderTable);
document.getElementById('dateStart').addEventListener('change', renderTable);
document.getElementById('dateEnd').addEventListener('change', renderTable);
document.getElementById('exportClients').addEventListener('click', ()=>exportClientsCSV());

document.querySelectorAll('.sortable').forEach(h=>{
  h.addEventListener('click', ()=>{
    const key = h.getAttribute('data-key');
    if (sortKey === key) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; } else { sortKey = key; sortDir = 'asc'; }
    renderTable();
  });
});

setInterval(fetchClients, 30000);
fetchClients();

// Load per-client stats (agreements count and last visit)
async function loadClientStats(list){
  for(const c of list){
    try {
      const [agreementsRes, visitRes] = await Promise.all([
        fetch(`/api/clients/${c.id}/agreements`),
        fetch(`/api/visits/byClient/${c.id}/recent`)
      ]);
      const agreements = await agreementsRes.json();
      const visit = await visitRes.json();
      clientStats.set(c.id, {
        agreementsCount: Array.isArray(agreements) ? agreements.length : 0,
        lastVisitTs: visit && visit.timestamp ? visit.timestamp : null
      });
    } catch(e){ /* ignore */ }
  }
  renderTable();
}

// Hook into fetchClients to load stats after base data
const _origFetchClients = fetchClients;
fetchClients = async function(){
  await _origFetchClients();
  await loadClientStats(currentData);
}
</script>
<script>
// تعديل/حذف عميل
let editingClientId = null;
async function editClient(id){
  try{
    const res = await fetch(`/api/clients/${id}`);
    if(!res.ok) throw new Error('failed');
    const data = await res.json();
    editingClientId = id;
    document.getElementById('editName').value = data.name||'';
    document.getElementById('editEmail').value = data.email||'';
    document.getElementById('editPhone').value = data.phone||'';
    document.getElementById('editStatus').value = data.status||'';
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
  }catch(e){
    console.warn('تعذر جلب بيانات العميل', e);
    alert('تعذر تحميل بيانات العميل');
  }
}

async function saveClient(){
  if(!editingClientId) return;
  try{
    const body = {
      name: document.getElementById('editName').value,
      email: document.getElementById('editEmail').value,
      phone: document.getElementById('editPhone').value,
      status: document.getElementById('editStatus').value
    };
    const token = document.cookie.split('; ').find(c => c.startsWith('XSRF-TOKEN='));
    const csrf = token ? decodeURIComponent(token.split('=')[1]) : '';
    const res = await fetch(`/api/clients/${editingClientId}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json','X-XSRF-TOKEN': csrf},
      body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error('failed');
    const modalEl = document.getElementById('editModal');
    bootstrap.Modal.getInstance(modalEl)?.hide();
    await fetchClients();
  }catch(e){
    console.warn('تعذر حفظ العميل', e);
    alert('تعذر حفظ التغييرات');
  }
}

async function deleteClient(id){
  if(!confirm('هل تريد حذف العميل؟')) return;
  try{
    const token = document.cookie.split('; ').find(c => c.startsWith('XSRF-TOKEN='));
    const csrf = token ? decodeURIComponent(token.split('=')[1]) : '';
    const res = await fetch(`/api/clients/${id}`, { method:'DELETE', headers:{'X-XSRF-TOKEN': csrf} });
    if(!res.ok) throw new Error('failed');
    await fetchClients();
  }catch(e){
    console.warn('تعذر حذف العميل', e);
    alert('تعذر حذف العميل');
  }
}

// عرض تفاصيل عميل
async function viewClient(id){
  try{
    const res = await fetch(`/api/clients/${id}`);
    if(!res.ok) throw new Error('failed');
    const data = await res.json();
    document.getElementById('detailName').textContent = data.name||'';
    document.getElementById('detailEmail').textContent = data.email||'';
    document.getElementById('detailPhone').textContent = data.phone||'';
    document.getElementById('detailStatus').innerHTML = statusBadge(data.status||'');
    document.getElementById('detailCreatedAt').textContent = formatDate(data.createdAt);
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    modal.show();
  }catch(e){
    console.warn('تعذر جلب تفاصيل العميل', e);
    alert('تعذر تحميل تفاصيل العميل');
  }
}

// تصدير العملاء (المُصفّيين حالياً) إلى CSV
function exportClientsCSV(){
  try{
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    const st = document.getElementById('statusFilter').value;
    const cf = document.getElementById('classificationFilter')?.value || '';
    const pf = document.getElementById('pipelineFilter')?.value || '';
    const ds = document.getElementById('dateStart').value;
    const de = document.getElementById('dateEnd').value;
    const filtered = currentData.filter(c => {
      const matchesQ = !q || [c.name,c.email,c.phone].some(v => (v||'').toLowerCase().includes(q));
      const matchesSt = !st || (c.status||'').toLowerCase() === st;
      const matchesCf = !cf || (c.classification||'').toLowerCase() === cf;
      const matchesPf = !pf || (c.pipelineStage||'').toLowerCase() === pf;
      let matchesDate = true;
      if (ds) { const sMs = new Date(ds).getTime(); const ca = new Date(c.createdAt).getTime(); matchesDate = matchesDate && (ca >= sMs); }
      if (de) { const eMs = new Date(de).getTime()+86400000-1; const ca = new Date(c.createdAt).getTime(); matchesDate = matchesDate && (ca <= eMs); }
      return matchesQ && matchesSt && matchesCf && matchesPf && matchesDate;
    });
    const rows = [
      ['Name','Status','Classification','Pipeline','Agreements','Last Visit','Created At'],
      ...filtered.map(c => {
        const stats = clientStats.get(c.id) || {};
        return [
          c.name||'', c.status||'', c.classification||'', c.pipelineStage||'',
          (stats.agreementsCount??'').toString(),
          stats.lastVisitTs ? new Date(stats.lastVisitTs).toISOString() : '',
          c.createdAt ? new Date(c.createdAt).toISOString() : ''
        ];
      })
    ];
    const csv = rows.map(r => r.map(v => '"'+String(v).replaceAll('"','""')+'"').join(',')).join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'clients_export.csv'; a.click();
    URL.revokeObjectURL(url);
  }catch(e){ console.warn('CSV export failed', e); alert('فشل تصدير CSV'); }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Modal: تعديل عميل -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تعديل العميل</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">الاسم</label>
          <input type="text" class="form-control" id="editName" />
        </div>
        <div class="mb-2">
          <label class="form-label">البريد</label>
          <input type="email" class="form-control" id="editEmail" />
        </div>
        <div class="mb-2">
          <label class="form-label">الهاتف</label>
          <input type="text" class="form-control" id="editPhone" />
        </div>
        <div class="mb-2">
          <label class="form-label">الحالة</label>
          <select class="form-select" id="editStatus">
            <option value="active">نشط</option>
            <option value="pending">معلّق</option>
            <option value="inactive">غير نشط</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button class="btn btn-primary" onclick="saveClient()">حفظ</button>
      </div>
  </div>
 </div>
</div>
<!-- Modal: تفاصيل عميل -->
<div class="modal fade" id="detailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تفاصيل العميل</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><strong>الاسم:</strong> <span id="detailName"></span></div>
        <div class="mb-2"><strong>البريد:</strong> <span id="detailEmail"></span></div>
        <div class="mb-2"><strong>الهاتف:</strong> <span id="detailPhone"></span></div>
        <div class="mb-2"><strong>الحالة:</strong> <span id="detailStatus"></span></div>
        <div class="mb-2"><strong>تاريخ الإضافة:</strong> <span id="detailCreatedAt"></span></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
      </div>
    </div>
  </div>
 </div>
</body>
</html>