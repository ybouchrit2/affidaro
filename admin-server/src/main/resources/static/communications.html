<!doctype html>
<html lang="ar" dir="rtl" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>الاتصالات - Affidaro Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body>
<div class="d-flex">
  <aside class="sidebar bg-dark text-white p-3">
    <h3 class="mb-4 text-center">Affidaro Admin</h3>
    <ul class="nav flex-column">
      <li class="nav-item mb-2"><a href="/dashboard.html" class="nav-link text-white"><i class="bi bi-speedometer2 me-2"></i> لوحة التحكم</a></li>
      <li class="nav-item mb-2"><a href="/clients.html" class="nav-link text-white"><i class="bi bi-people me-2"></i> العملاء</a></li>
      <li class="nav-item mb-2"><a href="/leads.html" class="nav-link text-white"><i class="bi bi-lightbulb me-2"></i> الطلبات</a></li>
      <li class="nav-item mb-2"><a href="/contracts.html" class="nav-link text-white"><i class="bi bi-file-earmark-text me-2"></i> العقود</a></li>
      <li class="nav-item mb-2"><a href="/analytics.html" class="nav-link text-white"><i class="bi bi-graph-up me-2"></i> التحليلات</a></li>
      <li class="nav-item mb-2"><a href="/communications.html" class="nav-link text-primary"><i class="bi bi-chat-dots me-2"></i> الاتصالات</a></li>
    </ul>
  </aside>

  <main class="flex-grow-1">
    <nav class="navbar navbar-expand bg-white shadow-sm p-3 sticky-top">
      <div class="container-fluid">
        <div class="input-group w-50">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="clientSearch" class="form-control" type="search" placeholder="ابحث عن عميل بالاسم/البريد/الهاتف" aria-label="Search">
        </div>
        <div>
          <button id="refreshBtn" class="btn btn-outline-primary" disabled><i class="bi bi-arrow-repeat"></i> تحديث</button>
        </div>
      </div>
    </nav>

    <section class="p-4">
      <div class="mb-3">
        <h5 class="fw-bold">اختر عميلًا</h5>
        <ul class="list-group" id="clientResults"></ul>
      </div>

      <div id="logsSection" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="fw-bold">سجلات الاتصالات</h4>
          <span id="selectedClient" class="text-muted"></span>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="logsTable">
            <thead class="table-light">
              <tr>
                <th>الوقت</th>
                <th>القناة</th>
                <th>المستخدم</th>
                <th>النتيجة</th>
                <th>التقييم</th>
                <th>ملاحظات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
let selectedId = null;
function safe(s){ return (s ?? '').toString(); }
function formatDate(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleString('ar-EG'); }
function outcomeBadge(o){
  const map = {
    'succeeded':['bg-success','bi-check2-circle'],
    'no_answer':['bg-warning','bi-telephone-x'],
    'scheduled':['bg-info','bi-calendar-event'],
    'sent':['bg-primary','bi-send'],
    'cancelled':['bg-danger','bi-x-circle']
  };
  const [cls, icon] = map[o] || ['bg-secondary','bi-dot'];
  return `<span class="badge ${cls}"><i class="bi ${icon}"></i> ${safe(o)}</span>`;
}

async function searchClients(){
  const q = document.getElementById('clientSearch').value.trim();
  if (!q) { document.getElementById('clientResults').innerHTML = ''; return; }
  const res = await fetch(`http://localhost:8090/api/clients/search?q=${encodeURIComponent(q)}`);
  const list = await res.json();
  const ul = document.getElementById('clientResults');
  ul.innerHTML = list.map(c => `<li class="list-group-item d-flex justify-content-between align-items-center">
      <span><i class="bi bi-person me-2"></i>${safe(c.name)} <small class="text-muted">${safe(c.email)} | ${safe(c.phone)}</small></span>
      <button class="btn btn-sm btn-outline-primary" onclick="selectClient(${c.id}, '${safe(c.name).replace(/'/g,"&#39;")}')">اختيار</button>
  </li>`).join('');
}

function selectClient(id, name){
  selectedId = id;
  document.getElementById('selectedClient').textContent = `العميل: ${name} (#${id})`;
  document.getElementById('logsSection').style.display = '';
  document.getElementById('refreshBtn').disabled = false;
  loadLogs();
}

async function loadLogs(){
  if (!selectedId) return;
  const res = await fetch(`http://localhost:8090/api/clients/${selectedId}/logs`);
  const logs = await res.json();
  const tbody = document.querySelector('#logsTable tbody');
  tbody.innerHTML = logs.map(l => `
    <tr>
      <td>${formatDate(l.timestamp)}</td>
      <td>${safe(l.channel)}</td>
      <td>${safe(l.userName)}</td>
      <td>${outcomeBadge(l.outcome)}</td>
      <td>${l.rating ?? ''}</td>
      <td>${safe(l.notes)}</td>
    </tr>
  `).join('');
}

document.getElementById('clientSearch').addEventListener('input', searchClients);
document.getElementById('refreshBtn').addEventListener('click', loadLogs);
setInterval(loadLogs, 30000);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>