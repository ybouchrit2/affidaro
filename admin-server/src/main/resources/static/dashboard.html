<!doctype html>
<html lang="ar" dir="rtl" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>لوحة التحكم - Affidaro Admin</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Custom CSS (optional) -->
  <!-- Removed missing /css/custom.css to avoid 404 during preview -->
</head>

<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <aside class="sidebar bg-dark text-white p-3">
      <h3 class="mb-4 text-center">Affidaro Admin</h3>
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a href="/dashboard.html" class="nav-link text-white"><i class="bi bi-speedometer2 me-2"></i> لوحة التحكم</a></li>
        <li class="nav-item mb-2"><a href="/clients.html" class="nav-link text-white"><i class="bi bi-people me-2"></i> العملاء</a></li>
        <li class="nav-item mb-2"><a href="/leads.html" class="nav-link text-white"><i class="bi bi-lightbulb me-2"></i> الطلبات</a></li>
        <li class="nav-item mb-2"><a href="/contracts.html" class="nav-link text-white"><i class="bi bi-file-earmark-text me-2"></i> العقود</a></li>
        <li class="nav-item mb-2"><a href="/analytics.html" class="nav-link text-white"><i class="bi bi-graph-up me-2"></i> التحليلات</a></li>
        <li class="nav-item mb-2"><a href="/communications.html" class="nav-link text-white"><i class="bi bi-chat-dots me-2"></i> الاتصالات</a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow-1">
      <!-- Top Navbar -->
      <nav class="navbar navbar-expand bg-white shadow-sm p-3 sticky-top">
        <div class="container-fluid">
          <form class="d-flex w-50">
            <input class="form-control me-2" type="search" placeholder="ابحث عن الصفحة/المرجع..." aria-label="Search">
          </form>
          <div class="d-flex align-items-center">
            <span class="me-3 fw-semibold">مرحبًا، المشرف</span>
            <i class="bi bi-person-circle fs-4"></i>
          </div>
        </div>
      </nav>

      <!-- Dashboard Content -->
      <section class="p-4">
        <div class="row g-3">
          <!-- Cards -->
          <div class="col-md-3">
            <div class="card shadow-sm border-0">
              <div class="card-body text-center">
                <h6>العملاء الإجماليون</h6>
                <h2 class="fw-bold text-primary"><span id="totalClients">—</span></h2>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card shadow-sm border-0">
              <div class="card-body text-center">
                <h6>العملاء الجدد اليوم</h6>
                <h2 class="fw-bold text-success"><span id="newClientsToday">—</span></h2>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card shadow-sm border-0">
              <div class="card-body text-center">
                <h6>متوسط الزيارة (ث)</h6>
                <h2 class="fw-bold text-warning"><span id="avgVisitDurationSec">—</span></h2>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card shadow-sm border-0">
              <div class="card-body text-center">
                <h6>الزيارات اليوم</h6>
                <h2 class="fw-bold text-danger"><span id="visitsToday">—</span></h2>
              </div>
            </div>
          </div>
        </div>

        <!-- جدول آخر الزيارات -->
        <div class="mt-5">
          <h5 class="mb-3 fw-bold">الزيارات الأخيرة</h5>
          <div class="table-responsive">
            <table class="table table-hover align-middle" id="visitsTable">
              <thead class="table-light">
                <tr>
                  <th>الوقت</th>
                  <th>الصفحة</th>
                  <th>المُحيل</th>
                  <th>المدة (ث)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- آخر زيارة لكل صفحة -->
        <div class="mt-4">
          <h5 class="mb-3 fw-bold">آخر زيارة لكل صفحة</h5>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle" id="lastByPageTable">
              <thead class="table-light">
                <tr>
                  <th>الصفحة</th>
                  <th>الوقت</th>
                  <th>المُحيل</th>
                  <th>المدة (ث)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script>
    const el = id => document.getElementById(id);
    const safe = v => v==null ? '—' : String(v);
    const formatDate = ts => { try { const d=new Date(ts); return `${d.toLocaleDateString()} ${d.toLocaleTimeString()}` } catch(e){ return '—'; } };

    function renderCards(summary){
      el('totalClients').textContent = safe(summary.totalClients);
      el('newClientsToday').textContent = safe(summary.newClientsToday);
      el('visitsToday').textContent = safe(summary.visitsToday);
      el('avgVisitDurationSec').textContent = Math.round((summary.avgVisitDuration||0)/1000);
    }

    function renderVisits(list){
      const tbody = document.querySelector('#visitsTable tbody');
      tbody.innerHTML = (list||[]).slice(0,10).map(v => `
        <tr>
          <td>${formatDate(v.timestamp)}</td>
          <td>${safe(v.page)}</td>
          <td>${safe(v.referrer)}</td>
          <td>${(v.durationMs||0)/1000 | 0}</td>
        </tr>
      `).join('');
    }

    function renderLastByPage(list){
      const map = new Map();
      (list||[]).forEach(v => {
        const key = v.page || '';
        const prev = map.get(key);
        const vTs = v.timestamp ? new Date(v.timestamp).getTime() : 0;
        const pTs = prev && prev.timestamp ? new Date(prev.timestamp).getTime() : -1;
        if (!prev || vTs > pTs) map.set(key, v);
      });
      const tbody = document.querySelector('#lastByPageTable tbody');
      const rows = Array.from(map.entries()).sort((a,b)=>{
        const ta = a[1].timestamp ? new Date(a[1].timestamp).getTime() : 0;
        const tb = b[1].timestamp ? new Date(b[1].timestamp).getTime() : 0;
        return tb - ta;
      }).slice(0,10);
      tbody.innerHTML = rows.map(([page,v]) => `
        <tr>
          <td>${safe(page)}</td>
          <td>${formatDate(v.timestamp)}</td>
          <td>${safe(v.referrer)}</td>
          <td>${(v.durationMs||0)/1000 | 0}</td>
        </tr>
      `).join('');
    }

    async function load(){
      try {
        const [sumRes, statsRes] = await Promise.all([
          fetch('/api/analytics'),
          fetch('/api/visits/stats')
        ]);
        const summary = await sumRes.json();
        const stats = await statsRes.json();
        renderCards(summary);
        renderVisits(stats.recent || []);
        renderLastByPage(stats.recent || []);
      } catch(e) {
        renderCards({});
        renderVisits([]);
        renderLastByPage([]);
      }
    }

    document.addEventListener('DOMContentLoaded', load);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>